name: 01 - Train Emotion Recognition Model

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'notebooks/**'
      - 'data/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov tensorflow==2.13.0

    - name: ðŸ“Š Download RAVDESS dataset
      run: |
        mkdir -p data/raw
        # Using Kaggle API to download dataset
        pip install kaggle
        # Store Kaggle credentials as secrets
        echo "${{ secrets.KAGGLE_JSON }}" > ~/.kaggle/kaggle.json
        chmod 600 ~/.kaggle/kaggle.json
        kaggle datasets download -d uwrfkaggler/ravdess-emotional-speech-audio
        unzip ravdess-emotional-speech-audio.zip -d data/raw/

    - name: ðŸš€ Train model
      run: |
        python scripts/train.py --epochs 50 --batch_size 32
      env:
        TF_CPP_MIN_LOG_LEVEL: 2

    - name: ðŸ“ˆ Evaluate model
      run: |
        python scripts/test.py --model_path models/emotion_model.h5

    - name: ðŸ’¾ Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: trained-model
        path: |
          models/emotion_model.h5
          models/scaler.pkl
          models/metadata.json

    - name: ðŸ“Š Generate training report
      run: |
        python scripts/generate_report.py

    - name: ðŸ“¤ Upload training report
      uses: actions/upload-artifact@v3
      with:
        name: training-report
        path: reports/training_report.html